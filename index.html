<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SURROGAT</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:sans-serif;overflow:hidden}
    h1{font-size:42px;margin:40px auto 20px;text-align:center;background:linear-gradient(90deg,#00ff41,#b026ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .btn{background:linear-gradient(90deg,#00ff41,#b026ff);color:#000;font-weight:900;font-size:24px;padding:22px;border-radius:25px;border:none;width:88%;margin:15px auto;display:block;box-shadow:0 15px 40px rgba(0,255,65,0.5);cursor:pointer}
    .back{position:fixed;top:15px;left:15px;background:rgba(255,255,255,0.2);padding:12px 20px;border-radius:50px;z-index:999;cursor:pointer}
    .switch{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.3);padding:15px 40px;border-radius:50px;z-index:999;cursor:pointer}
    video{width:100vw;height:100vh;object-fit:cover}
    .item{background:#111;margin:12px 0;padding:18px;border-radius:15px;display:flex;justify-content:space-between;align-items:center}
    .item p{margin:0;color:#0f0;font-weight:700}
    .private-btn{background:#b026ff;color:#fff;padding:12px 28px;border-radius:12px;border:none;font-weight:700;cursor:pointer}
    .status{position:fixed;bottom:0;left:0;right:0;background:rgba(0,120,0,0.9);padding:18px;color:#0f0;text-align:center;font-size:19px}
  </style>
</head>
<body>

  <div id="main">
    <h1>SURROGAT</h1>
    <button class="btn" onclick="watch()">ОНЛАЙН НОСИТЕЛИ</button>
    <button class="btn" onclick="carrier()">Я НОСИТЕЛЬ — НАЧАТЬ</button>
  </div>

  <div id="list" style="display:none">
    <div class="back" onclick="location.reload()">Назад</div>
    <h1>Онлайн носители</h1>
    <div id="online" style="padding:20px"></div>
  </div>

  <script>
    const tg = Telegram.WebApp;
    tg.ready(); tg.expand();

    const name = tg.initDataUnsafe.user?.first_name || "Гость";
    let stream = null;
    let roomId = "room_" + Date.now() + Math.random().toString(36).substr(2,5);

    // ЭТОТ СЕРВЕР РАБОТАЕТ ПРЯМО СЕЙЧАС — ВСЕ ЗАЩИТЫ ОТКЛЮЧЕНЫ
    const ws = new WebSocket('wss://surrogat-open.deno.dev');

    function carrier() {
      navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
        stream = s;
        document.body.innerHTML = `
          <div class="back" onclick="location.reload()">Назад</div>
          <video autoplay playsinline muted style="transform:scaleX(-1)"></video>
          <div class="switch" onclick="switchCam()">Сменить камеру</div>
          <div class="status">Ты в эфире как <b>${name}</b></div>`;
        document.querySelector("video").srcObject = stream;

        // Регистрация без фильтров
        ws.send(JSON.stringify({type:"join", roomId, name}));
      }).catch(e => alert("Камера не доступна: " + e.message));
    }

    function watch() {
      document.getElementById("main").style.display = "none";
      document.getElementById("list").style.display = "block";
      updateList();
      setInterval(updateList, 3000);
    }

    function updateList() {
      ws.send(JSON.stringify({type:"list"}));
    }

    ws.onmessage = e => {
      const d = JSON.parse(e.data);
      if (d.type === "users") {
        const div = document.getElementById("online");
        div.innerHTML = "";
        if (d.users.length === 0) {
          div.innerHTML = "<p style='text-align:center;color:#555;padding:50px 0'>Пока никого нет</p>";
        } else {
          d.users.forEach(u => {
            const el = document.createElement("div");
            el.className = "item";
            el.innerHTML = `<p>${u.name}</p><button class="private-btn" onclick="alert('Приватный стрим с ${u.name} скоро здесь')">ПРИВАТ</button>`;
            div.appendChild(el);
          });
        }
      }
    };

    window.switchCam = async () => {
      if (!stream) return;
      const v = stream.getVideoTracks()[0];
      const newFacing = v.getSettings().facingMode === "user" ? "environment" : "user";
      const newStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:newFacing}, audio:true});
      document.querySelector("video").srcObject = newStream;
      v.stop();
      stream = newStream;
    };
  </script>
</body>
</html>
