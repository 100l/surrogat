<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SURROGAT</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.100ms.live/v2/hms.js"></script>
  <style>
    body {margin:0;background:#000;color:#fff;font-family:sans-serif;text-align:center;padding:20px}
    h1{font-size:38px;margin:30px 0 10px;background:linear-gradient(90deg,#00ff41,#b026ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    p{font-size:18px;opacity:0.9;line-height:1.5}
    .btn{background:linear-gradient(90deg,#00ff41,#b026ff);color:#000;font-weight:900;font-size:22px;padding:20px;border-radius:20px;border:none;width:92%;margin:20px auto;display:block;box-shadow:0 10px 40px rgba(0,255,65,0.5);cursor:pointer}
    .menu {display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);z-index:10;padding:100px 20px}
    .menu-btn {background:#111;padding:15px;border-radius:15px;margin:15px 0;cursor:pointer}
    video {width:100%;height:100vh;object-fit:cover}
  </style>
</head>
<body>

  <h1>SURROGAT</h1>
  <p>Бесплатный публичный просмотр<br>Приватный суррогат с командами — от 1500 ⭐</p>

  <button class="btn" id="watchPublic">Смотреть публичный бесплатно</button>
  <button class="btn" id="startPrivate">Приватный суррогат</button>
  <button class="btn" id="becomeCarrier">Я носитель — начать стрим</button>

  <div id="privateMenu" class="menu">
    <button class="menu-btn" onclick="selectPrivate(10)">10 мин — 1500 ⭐</button>
    <button class="menu-btn" onclick="selectPrivate(30)">30 мин — 3000 ⭐</button>
    <button class="menu-btn" onclick="selectPrivate(60)">60 мин — 5000 ⭐</button>
  </div>

  <div id="cameraMenu" class="menu">
    <button class="menu-btn" onclick="selectCamera('user')">Фронтальная камера</button>
    <button class="menu-btn" onclick="selectCamera('environment')">Основная камера</button>
  </div>

  <script>
    const tg = Telegram.WebApp;
    tg.ready(); tg.expand();

    const ROOM_ID = "6757f3f0c5b0c71b1e8b4567"; // Твой room в 100ms
    const TOKEN_ENDPOINT = "https://surrogat-token.deno.dev/token"; // Токен-сервер

    const privateMenu = document.getElementById('privateMenu');
    const cameraMenu = document.getElementById('cameraMenu');
    let selectedTime = 0;
    let selectedFacing = 'environment'; // По умолчанию основная

    // Публичный просмотр
    document.getElementById('watchPublic').addEventListener('click', async () => {
      const token = await fetch(`${TOKEN_ENDPOINT}?room=${ROOM_ID}&role=viewer`).then(res => res.text());
      const hms = HMS.create({ token });
      hms.join({ userName: 'Зритель' });
      document.body.innerHTML = '<video id="video" autoplay playsinline></video>';
      hms.on('track', track => {
        if (track.kind === 'video') track.attach(document.getElementById('video'));
      });
    });

    // Приватный суррогат (показываем меню времени)
    document.getElementById('startPrivate').addEventListener('click', () => {
      privateMenu.style.display = 'block';
    });

    // Выбор времени и оплата
    window.selectPrivate = (minutes) => {
      privateMenu.style.display = 'none';
      selectedTime = minutes;
      let stars = minutes * 50; // 10мин=500? Wait, per your: 10=1500,30=3000,60=5000
      if (minutes === 10) stars = 1500;
      if (minutes === 30) stars = 3000;
      if (minutes === 60) stars = 5000;

      tg.openInvoice({
        title: `Приватный суррогат — ${minutes} минут`,
        description: 'Эксклюзив + голосовые команды. Комиссия платформы 5%',
        payload: 'private_surrogat_' + minutes,
        provider_token: '',
        currency: 'XTR',
        prices: [{ label: `${minutes} мин`, amount: stars }]
      }, async (success) => {
        if (success) {
          // Комиссия 5% (симуляция — в реале backend отнимает)
          const commission = stars * 0.05;
          console.log(`Комиссия платформы: ${commission} ⭐`);

          // Подключаемся к приватному стриму
          const token = await fetch(`${TOKEN_ENDPOINT}?room=${ROOM_ID}&role=viewer`).then(res => res.text());
          const hms = HMS.create({ token });
          hms.join({ userName: 'Суррогат' });
          const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          hms.publish(audioStream.getAudioTracks()[0]);
          document.body.innerHTML = '<video id="video" autoplay playsinline></video>';
          hms.on('track', track => {
            if (track.kind === 'video') track.attach(document.getElementById('video'));
          });
          // Таймер на окончание
          setTimeout(() => {
            hms.leave();
            tg.showAlert('Время приватного суррогата закончилось. Оцените носителя');
            // Рейтинг
            tg.showPopup({
              title: 'Оцените носителя',
              message: '1-5 звёзд',
              buttons: [{text: '1⭐', id: '1'}, {text: '2⭐', id: '2'}, {text: '3⭐', id: '3'}, {text: '4⭐', id: '4'}, {text: '5⭐', id: '5'}]
            }, (buttonId) => {
              console.log('Рейтинг: ' + buttonId.id);
              // Сохранить в Firebase
            });
          }, minutes * 60 * 1000);
        }
      });
    };

    // Стримить (показываем меню камеры)
    document.getElementById('becomeCarrier').addEventListener('click', () => {
      cameraMenu.style.display = 'block';
    });

    // Выбор камеры и начало стрима
    window.selectCamera = async (facingMode) => {
      cameraMenu.style.display = 'none';
      selectedFacing = facingMode;
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: selectedFacing }, audio: true });
      const token = await fetch(`${TOKEN_ENDPOINT}?room=${ROOM_ID}&role=host`).then(res => res.text());
      const hms = HMS.create({ token });
      hms.join({ userName: 'Носитель' });
      hms.publish(stream);
      document.body.innerHTML = '<video id="video" autoplay playsinline muted style="width:100%;height:100vh;object-fit:cover;transform:scaleX(-1)"></video>';
      stream.getVideoTracks()[0].attach(document.getElementById('video'));
      // Рейтинг после
      tg.showPopup({title: 'Оцените зрителя', ...}); // Аналогично для носителя
    };
  </script>
</body>
</html>
