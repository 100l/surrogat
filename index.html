<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SURROGAT</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;background:#000;color:#fff;font-family:sans-serif;overflow:hidden}
    h1{font-size:42px;margin:40px auto 20px;text-align:center;background:linear-gradient(90deg,#00ff41,#b026ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .btn{background:linear-gradient(90deg,#00ff41,#b026ff);color:#000;font-weight:900;font-size:24px;padding:22px;border-radius:25px;border:none;width:88%;margin:20px auto;display:block;box-shadow:0 15px 40px rgba(0,255,65,0.5);cursor:pointer}
    .back{position:fixed;top:15px;left:15px;background:rgba(255,255,255,0.2);padding:12px 20px;border-radius:50px;z-index:999;font-size:28px;cursor:pointer}
    video{width:100vw;height:100vh;object-fit:cover}
  </style>
</head>
<body>

  <div id="main">
    <h1>SURROGAT</h1>
    <button class="btn" onclick="watch()">Смотреть стрим</button>
    <button class="btn" onclick="start()">Я носитель — начать стрим</button>
  </div>

  <script>
    const tg = Telegram.WebApp;
    tg.ready(); tg.expand();

    const name = tg.initDataUnsafe.user?.first_name || "Носитель";

    async function start() {
      const stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
      document.body.innerHTML = `<div class="back" onclick="location.reload()">Назад</div><video autoplay playsinline muted style="transform:scaleX(-1)"></video>`;
      document.querySelector("video").srcObject = stream;

      // Публикуем себя в публичный канал
      fetch(`https://surrogat-bot.deno.dev/add?name=${encodeURIComponent(name)}&id=${tg.initDataUnsafe.user?.id || Date.now()}`)
        .then(() => console.log("Ты в эфире"));
    }

    function watch() {
      document.body.innerHTML = `<div class="back" onclick="location.reload()">Назад</div><h1>Онлайн носители</h1><div id="list" style="padding:20px"></div>`;

      const list = document.getElementById("list");
      const update = () => {
        fetch("https://surrogat-bot.deno.dev/list")
          .then(r => r.json())
          .then(data => {
            list.innerHTML = "";
            if (data.length === 0) {
              list.innerHTML = "<p style='text-align:center;color:#555'>Никого нет онлайн</p>";
              return;
            }
            data.forEach(u => {
              const div = document.createElement("div");
              div.style = "background:#111;margin:15px 0;padding:18px;border-radius:15px;display:flex;justify-content:space-between;align-items:center";
              div.innerHTML = `<p style="margin:0;color:#0f0;font-weight:700">${u.name}</p>
                <button style="background:#b026ff;color:#fff;padding:12px 25px;border-radius:12px;border:none;font-weight:700" onclick="connect('${u.id}')">Приват</button>`;
              list.appendChild(div);
            });
          });
      };
      update();
      setInterval(update, 4000);
    }

    window.connect = (id) => {
      alert("Приватный стрим с " + id + " — будет через 5 минут");
      // Здесь будет WebRTC по ID
    };
  </script>
</body>
</html>
